{"summary": "a mature library of computational approaches has been developed to infer its targets and mechanisms at the molecular level. a key feature of natural selection is its variability. the strength and direction of selective effects differ from site to site and change over time, and an ideal model should produce reliable results in presence of such variation. the first tractable \u201cbranch-site\u201d model incorporated limited variation in both sites and among branches and could be used for detecting episodic positive selection. the model explicitly disallow positive selection on a subset of \u201cbackground\u201d lineages. the adaptive BSREL (aBSREL) model developed and presented here exploits this phenomenon by adapting its complexity to the data set. if the branch is very short, the number of substitutions observed will not be very different at different sites, and it will not be possible to accurately infer multiple rate categories. each panel depicts the fraction of all alignments reported by aBSREL as having more than one rate class selected by the step-up procedure (Kb), as a function of (A) the length of the alignment (codons), censored at 2,000 due to sparse sampling afterwards. the rate of instantaneous substitution from a sense codon x to a sense codon y is described by the (x, y) entry in the generator matrix ( Q = q x y ). only single nucleotide substitutions (from nucleotide i A, C, G, T in codon x to nucleotide j in codon y) have nonzero instantaneous rates. the equilibrium frequency of a particular codon is the product of position-specific j p for the three constituent nucleotides. it can also be shown that the equilibrium frequency of a particular codon is the product of position-specific j p for the three constituent nucleotides. k enumerates Kb Both BSREL and aBSREL focus their attention on estimation of codon-level rates, denoted by r b s ( x, y ) and superscript bs used to make explicit the dependence of model parameters on a specific branch in the phylogeny (b) only synonymous and nonsynonymous codon substitution rates are distinguished. k b and f k b are estimated from the data using a step-up procedure. the result of this procedure is a single branch-site REL model. each branch b has been assigned a model complexity Kb ranging from 1 to a predefined limit. one defines the transition probability matrix, Pb ( for each branch b) as the convex mixture of Kb transition matrices. in calculating individual rate matrix entries q x y b s Q k b, the distribution b ( s ) is replaced by individual k b parameters. for aBSREL, fix all current parameter estimates at their current estimated values, except for those affecting the branch currently considered (b) step 4 is essential for ensuring that aBSREL is computationally tractable; otherwise we would be performing O(B) complete codon-based optimizations. our greedy procedure will be sensitive to the order in which parameters are considered. we consider longest branches first because parameters added early on in the selection process affect all downstream inference. short branches are assumed to have relatively little impact on the model likelihood and on inference at other branches. the aBSREL complexity analysis could infer K b = 1 (the correct model), or K b > 1 (an overfitted model) the distribution of the LRT statistic is then dependent on the outcome of model selection: LRT 0.5 ( 0 2 + 1 2 ), K b = 1, i = 0 2 K b 1 c i i 2, K b > 1. 20% to 1 2, 30% to 2 2 is in excellent agreement with the tail of the empirical LRT distribution based on 50,000 samples (10,000 replicates of five-branch trees) simulated under a strict null ( = 1 everywhere) test statistic is more conservative than the 50:50 mixture of 0 2 and 1 2 used in the original BSREL paper. the rate of instantaneous substitution from a sense codon x to a sense codon y is described by the (x, y) entry in the generator matrix ( Q = q x y ). only single nucleotide substitutions (from nucleotide i A, C, G, T in codon x to nucleotide j in codon y) have nonzero instantaneous rates. the equilibrium frequency of a particular codon is the product of position-specific j p for the three constituent nucleotides. it can also be shown that the equilibrium frequency of a particular codon is the product of position-specific j p for the three constituent nucleotides. k enumerates Kb Both BSREL and aBSREL focus their attention on estimation of codon-level rates, denoted by r b s ( x, y ) and superscript bs used to make explicit the dependence of model parameters on a specific branch in the phylogeny (b) only synonymous and nonsynonymous codon substitution rates are distinguished. k b and f k b are estimated from the data using a step-up procedure. the result of this procedure is a single branch-site REL model. each branch b has been assigned a model complexity Kb ranging from 1 to a predefined limit. one defines the transition probability matrix, Pb ( for each branch b) as the convex mixture of Kb transition matrices. assuming independence among sites, the likelihood of the entire alignment is obtained as the product of individual site likelihoods. a single rate class per branch is permitted to represent positive selection. aBSREL follows these steps: Sort all branches by their length under the baseline model in descending order and iterate over sorted branches. fix all current parameter estimates at their current estimated values, except for those affecting the branch currently considered (b) the model selection algorithm runs at speeds which are essentially independent of the number of sequences in the full alignment. we consider longest branches first because parameters added early on in the selection process affect all downstream inference. short branches are assumed to have relatively little impact on the model likelihood and on inference at other branches. the aBSREL complexity analysis could infer K b = 1 (the correct model), or K b > 1 (an overfitted model) the distribution of the LRT statistic is then dependent on the outcome of model selection: LRT 0.5 ( 0 2 + 1 2 ), K b = 1, i = 0 2 K b 1 c i i 2, K b > 1. 20% to 1 2 and 30% to 2 2 is in excellent agreement with the tail of the empirical LRT distribution based on 50,000 samples (10,000 replicates of five-branch trees) simulated under a strict null ( = 1 everywhere) model. this test statistic is more conservative than the 50:50 mixture used in the original BSREL paper. this rate applied to the worst case scenario of strict neutrality on all branches. the empirical test mixture statistic derived from null simulations on the four-taxon tree also controlled false positive rates. the rate of false detection was significantly below 5% for branches where the largest k b was much less than 1. simulated with more than one rate class, 47% of rate classes beyond the first were recovered by aBSREL. this includes scenarios where recovery was potentially confounded by rates with very low proportions, very small differences between values, or by very short branches with very few total substitutions. the step-up procedure successfully optimized AICc, yielding the best scoring result among the three models compared. aBSRELe 3,415.0 60 6,954.0 3,552.7 2.30 44.0 3 (6) 00:02:35 BSREL 3,410.2 110 7,054.2 3,642.6 2.51 100 3 (6) 00:07:05 ( 2.7 ) EBOV 32 463 MG94 6,660.9 136 13,596.3 7,150.7 4.47 0.0 \u2014\u2014 aBSRELd,e 6,604.4 150 13,512.0 7,131.3 1, 623.05 f 11.0 eFor each data set, the model with the best AICc on the validation subset of the alignment (see text). eFor each data set, the model with the best AICc on the validation subset of the alignment (see text). eFor each data set, the model with the best AICc on the validation subset of the alignment (see text). the aBSREL model selection procedure identifies 7/16 (44%) branches with K b = 2 and 9/16 which were adequately described by the baseline MG94 model ( K b = 1 ). with only 14 additional parameters relative to the baseline model, aBSREL captured most of the likelihood improvement seen with the full BSREL model. aBSREL collapsed two of the rate classes inferred by BSREL. each branch b is annotated according to the inferred b distribution. the total length of the branch is partitioned according to the proportion of sites in a particular class ( f k b) aBSREL found only 2/17 branches with evidence of more than one (two each) classes. aBSREL performed the tests on all branches 7.9 faster. neither aBSREL nor BSREL identified any branches as subject to episodic diversifying selection. aBSREL tested all 33 branches 2.3 faster than BSREL. only a small proportion of branches supported models with multiple rate classes. branches with significant uncorrected P 0.05 rarely survive multiple testing corrections. aBSREL Analysis of 8,893 Selectome Coding Alignments (493,172 total branches). Kb % of Total Median (interquartile range) % with P 0.05 Branch Length Sequence Length. aBSREL evinced episodic selection along at least one branch in 2,079 alignments. this number increases to 7,109 (80.0%) if no multiple testing correction is carried out. aBSREL reported a positive finding of positive diversifying selection. we benchmarked our implementation of aBSREL versus fastCODEML 1.1 on the six empirical data sets discussed previously. aBSREL runs dramatically faster (up to three orders of magnitude) on the same hardware, using comparable or smaller memory footprints, with increasing benefits for larger data sets. aRun times were extrapolated from testing ten branches, because of long run times of the NY method. bRun times were extrapolated from testing three branches, because of long run times of the NY method. false positive rate for detecting episodic positive selection was well controlled at less than 5% using a nominal test size of 0.05. episodic selection was found for 80\u201390% of the branches. only 2% of branches simulated under a single rate class were inferred to have more than one rate class. 47% of rate classes beyond the first were recovered by aBSREL. validation sets technique from machine learning to explore the generalizability of the model. we trained the aBSREL model on randomly chosen 50% of alignment sites (the training set), then fitted that (now fixed) model to the remaining 50% of the sites (validation) this generally yielded a simpler model than that inferred from the entire alignment. d,e 1,012.6 80 2,190.6 1,168.3 0.23 0.0 0 (0) 00:00:59 BSREL 1,009.2 212 2,483.8 1,513.7 0.25 100 0 (0) 00:02:25 (2.8 ) bThe numbers in parentheses show the counts based on uncorrect. eFor each data set, the model with the best AICc on the validation subset of the alignment. fAt least one branch in the tree was saturated, that is, had an estimated length equivalent to numerical infinity. alignment includes sequences from ten mammalian species coding for the extracellular domain of the cluster of differentiation 2 receptor found in the T-helper and natural killer cells. branches in the phylogeny assumed to have K b = 3 under aBSREL model do not support this level complexity. for example, the short (0.002 substitutions/site) branch leading to \"baboon\" was inferred to have a single = 0.0 under aBSREL (no nonsynonymous substitutions) each branch b is annotated according to the inferred b distribution. the total length of the branch is partitioned according to the proportion of sites in a particular class ( f k b ). the color of the segment depicts the magnitude of the corresponding k b. aBSREL tested all 33 branches 2.3 faster than BSREL. aBSREL tested all 33 branches 2.3 faster than BSREL. a single branch remains significant for aBSREL, whereas none do for BSREL (using the more appropriate mixture statistic defined in this article) the step-up procedure successfully optimized AICc, yielding the best scoring result among the three models compared. aBSRELe 13,260.2 52 26,624.9 13,230.1 0.74 11.8 0 (1) 00:01:59 BSREL 13,255.0 116 26,744.3 13,348.9 0.74 100 0 (1) 00:15:48 ( 7.9 ) EBOV 32 463 MG94 6,660.9 136 13,596.3 7,150.7 4.47 0.0 \u2014\u2014 aBSRELd,e 6,914.5 518 24,882.5 12,689.5 5.22 4.6 1 aBSREL 43,568.56 1,140 89,440.61 44,515.8 301.74 f 6.0 1 (7) 09:33:38 BSREL 43,531.1 3,200 93,650.7 48,859.5 3, 647 f 100 0 (8) 36:08:50 (3.8) aModel AICc on the validation subset of the alignment (see text) aBSREL captured most of the likelihood improvement seen with the full BSREL model. both methods found the same three branches to be under positive selection. aBSREL tested all branches for evidence of positive selection 2.7 faster than BSREL. selection analyses of the extracellular domain of the mammalian CD2 receptor with the standard BSREL and the aBSREL models. each branch b is annotated according to the inferred b distribution; the total length of the branch is partitioned according to the proportion of sites in a particular class ( f k b ). the color of the segment depicts the magnitude of the corresponding k b. neither aBSREL nor BSREL identified any branches as subject to episodic diversifying selection. aBSREL tested all 33 branches 2.3 faster than BSREL, and similarly found no branches under selection. only a small proportion of branches supported models with multiple rate classes. branches with significant uncorrected P 0.05 rarely survive multiple testing corrections. aBSREL is always preferred to BSREL by AICc. codons Branch Count Corrected Uncorrected 1 84.51 0.02 (0.005\u20130.05) 145 (89\u2013226) 67 (55\u201377) 0.0043 0.054 2 15.46 0.16 (0.08\u20130.42) 190 (124\u2013293) 63 (51\u201373) 3.5 26.6 3 0.028 0.46 (139\u2013412.5) 67 (55\u201377) 9.6 78.6 Branches inferred to have multiple rate classes tended aBSREL evinced episodic selection along at least one branch in 2,079 alignments. this number increases to 7,109 (80.0%) if no multiple testing correction is carried out. previous analyses with uncorrected P values found at least one branch under selection in 3,747 of these alignments. we benchmarked our implementation of aBSREL versus fastCODEML 1.1 on the six empirical data sets discussed previously. we measured the time it took to test all internal branches in the tree one at a time. aBSREL runs dramatically faster (up to three orders of magnitude) on the same hardware. aRun times were extrapolated from testing ten branches, because of long run times of the NY method. bRun times were extrapolated from testing three branches, because of long run times of the NY method. aBSREL is the first branch-site approach to allow the complexity of the model to be inferred from the data together with continuous model parameters. we have explored the statistical performance of the test by sampling from the parametric space in a systematic manner. this allowed us to discover \u201cedge\u201d cases and revealed that the asymptotic distribution for the likelihood ratio statistic is more complex than we had previously thought. we realized that the test statistic in the BSREL method could lead to anticonservative behavior in worst-case scenarios. more robust approaches including model-averaging in information theoretic are not practical in the context of codon-substitution branch-site models because of the computational complexity of fitting even a single model. the congruence between the inferences of aBSREL and the BSREL model of fixed complexity on biological data is encouraging. variation by incorporating nonsynonymous rates into codon-based models has long been recognized. aBSREL tends to infer only a small number of rate categories. a single rate category can also be inferred even when there is substantial site-to-site heterogeneity. selective forces such as mRNA secondary structure can affect inferences of positive selection, especially for viral sequences. incorporating these features into aBSREL could return increased power from greater biological realism, at the expense of additional computation complexity. to investigate false positive rates in the worst case, we simulated 10,000 alignments with 1,000 codons each. supplementary figure S3, Supplementary Material online, resulting in at least 50 branches per hexagon. all values were limited to [ 0, 10 ], and all but one rate class proportions were further limited to between 0 and 1. negative selection strengths for branches with a single rate class were drawn from an exponential distribution with a rate parameter of 2. for comparison purposes, we modified aBSREL to take advantage of the same procedure for finding a good starting point for full model optimization as aBSREL. we did not count the time needed to find the starting point in BSREL runtime metrics, thereby biasing the comparison against aBSREL. simulated 10,000 alignments with 1,000 codons each using a balanced four-taxon tree assuming = 1 along every branch in the tree. 400 alignments with 1,000 codons each using a balanced 32-taxon tree. despite its simplicity, we previously used the same four-taxon setup to demonstrate undesirable statistical behaviors of the Yang and Nielsen (2002) class of models. the number of rate classes was drawn from a Poisson distribution ( = 2) truncated to take values in 1, 2, 3. after 500 rejections, the number of rate classes for a branch was automatically increased to 3. implementation and Availability aBSREL is implemented in the HyPhy software package (Kosakovsky Pond et al. 2005) as part of HyPhy, it uses OpenMP, pthreads, MPI, SIMD intrinsics, and other technologies to parallelize individual likelihood calculations."}